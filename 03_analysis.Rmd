---
title: "03_analysis"
author: "Sglatt"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages
```{r packages}
if (!require("lme4")) {
  install.packages("lme4")
  require("lme4")
}
if (!require("lmerTest")) {
  install.packages("lmerTest")
  require("lmerTest")
}
if (!require("glmmTMB")) {
  install.packages("glmmTMB")
  require("glmmTMB")
}
if (!require("sjPlot")) {
  install.packages("sjPlot")
  require("sjPlot")
}
if (!require("jmv")) {
  install.packages("jmv")
  require("jmv")
}
if (!require("dplyr")) {
  install.packages("dplyr")
  require("dplyr")
}
if (!require("psych")) {
  install.packages("psych")
  require("psych")
}
if (!require("tidyverse")) {
  install.packages("tidyverse")
  require("tidyverse")
}
if (!require("emmeans")) {
  install.packages("emmeans")
  require("emmeans")
}

# Cohen's d for familiar effect sizes from MLMs
lme.dscore <- function(mod, data, type) {
  if (type == "lme4") {
    mod1 <- lmerTest::lmer(mod, data = data)
    eff <- cbind(summary(mod1)$coefficients[, 4], summary(mod1)$coefficients[, 3])
  }

  if (type == "nlme") {
    eff <- cbind(summary(mod)$tTable[, 4], summary(mod)$fixDF$terms)
  }

  colnames(eff) <- c("t", "df")
  eff <- as.data.frame(eff)
  eff$d <- (2 * eff$t) / sqrt(eff$df)
  eff <- eff[-1, ]
  return(eff)
}
```

```{r folder to save output}
if (!dir.exists("03_Output")) {
  dir.create("03_Output")
}
```

# Data
Data for modality x time models; created in 01_data.Rmd
```{r mlm data}
# Continuous outcomes data
plf_data_filtered <- read.csv("01_Output/treatment_data_sg_2025-12-15.csv")

# Filter outcomes data to pre and post treatment (remove -9)
plf_data_treatment <- plf_data_filtered %>%
  filter(month %in% c(0, 3, 6, 12))

# Look at modality n's
table(plf_data_treatment[plf_data_treatment$month == 0, ]$modality_type)

# Exclude multi-modal participants
plf_data_treatment_sens <- plf_data_treatment %>%
  filter(modality_type != 3)

# Make a baseline dataset
plf_data_baseline <- plf_data_treatment %>%
  filter(month == 0)

plf_data_baseline_sens <- plf_data_baseline %>%
  filter(modality_type != 3)

# Confirm
table(plf_data_baseline$modality_type_new)
```

Data for initiation/engagement; created in 01_data.Rmd
```{r itt data}
plf_data_itt <- read.csv("01_Output/initiation_data_sg_2026-01-02.csv")
```

# Make MLM vars
```{r mlms vars}
plf_data_treatment_sens <- plf_data_treatment_sens %>%
  mutate(
    modality_type_new_f = as.factor(modality_type_new), # convert original to factor
    modality_f = factor(modality_type_new_f, levels = c(0, 1), labels = c("In-person", "Telehealth")),
    month_f = factor(month, levels = c(0, 3, 6, 12)),
    site_new_f = as.factor(site_new)
  )

# Make a baseline SI variable
ssi_bl <- plf_data_treatment %>%
  filter(month == 0) %>%
  dplyr::select(id, ssi)

# Add baseline SI to all data
plf_data_treatment_sens <- plf_data_treatment_sens %>%
  left_join(ssi_bl, by = "id", suffix = c("", "_bl"))
```

# Did treatment engagement differ by modality?
## Raw comparisons
```{r engage raw}
# in-person session attendance
summary(plf_data_baseline_sens[plf_data_baseline_sens$modality_type_new == 0, ]$n_sessions_attended)
sd(plf_data_baseline_sens[plf_data_baseline_sens$modality_type_new == 0, ]$n_sessions_attended)

# telehealth session attendance
summary(plf_data_baseline_sens[plf_data_baseline_sens$modality_type_new == 1, ]$n_sessions_attended)
sd(plf_data_baseline_sens[plf_data_baseline_sens$modality_type_new == 1, ]$n_sessions_attended)

# Comparison
wilcox.test(n_sessions_attended ~ modality_type_new, data = plf_data_baseline_sens)

# R&R, add range and IQR
plf_data_baseline_sens %>%
  group_by(modality_type_new) %>%
  summarise(
    n = n(),
    median_sessions = median(n_sessions_attended, na.rm = TRUE),
    IQR_sessions = IQR(n_sessions_attended, na.rm = TRUE)
  )
```

## Adjusted for ideation and site; modeled as predictors
- In the full intent-to-treat sample so to not condition on treatment initiation 
  [but we need to condition on initiation for engagement/completion outcomes, otherwise they are conflated]
- Based on randomization assignment to in-person versus telehealth delivery; 
  participants who transitioned modalities due to COVID-19 were classified according to their original assignment for ITT purposes. 
```{r engage adjust}
# Model treatment engagement and completion as ITT outcomes,
# not a group descriptor

# Initiation model (>0 sessions), ITT
initiation_model_itt <- glm(
  initiated ~ as.factor(modality_assign) + as.factor(site_new) + ssi,
  data = plf_data_itt,
  family = binomial
)

summary(initiation_model_itt)
exp(cbind(
  OR = coef(initiation_model_itt),
  confint(initiation_model_itt)
))

# Engagement model (> 5 sessions) - ITT for revisions,
# But also checking not ITT (or else inflated by initiation)
engagement_model_itt <- glm(
  six_sess ~ as.factor(modality_assign) + as.factor(site_new) + ssi,
  data = plf_data_itt,
  family = binomial
)

summary(engagement_model_itt)
exp(cbind(
  OR = coef(engagement_model_itt),
  confint(engagement_model_itt)
))

engagement_model_mitt <- glm(
  six_sess ~ as.factor(modality_f) + as.factor(site_new) + ssi_bl,
  data = plf_data_treatment_sens[plf_data_treatment_sens$month == 0, ],
  family = binomial
)

summary(engagement_model_mitt)
exp(cbind(
  OR = coef(engagement_model_mitt),
  confint(engagement_model_mitt)
))

# Completion model (10+ sessions) - ITT for revisions,
# But also checking not ITT (or else inflated by initiation)
completion_model_itt <- glm(
  completer ~ as.factor(modality_assign) + as.factor(site_new) + ssi,
  data = plf_data_itt,
  family = binomial
)

summary(completion_model_itt)
exp(cbind(
  OR = coef(completion_model_itt),
  confint(completion_model_itt)
))

completion_model_mitt <- glm(
  completer ~ as.factor(modality_f) + as.factor(site_new) + ssi_bl,
  data = plf_data_treatment_sens[plf_data_treatment_sens$month == 0, ],
  family = binomial
)

summary(completion_model_mitt)
exp(cbind(
  OR = coef(completion_model_mitt),
  confint(completion_model_mitt)
))

# Session count model - ITT for revisions,
# But also checking not ITT (or else inflated by initiation)

# Check for overdispersion
mean(plf_data_itt$n_sessions_attended, na.rm = TRUE)
var(plf_data_itt$n_sessions_attended, na.rm = TRUE)
# Variance is > mean, so use a negative binomial model

attendance_model_itt <- glmmTMB(
  n_sessions_attended ~ as.factor(modality_assign) + ssi + as.factor(site_new),
  data = plf_data_itt,
  family = nbinom2
)

summary(attendance_model_itt)

attendance_model_mitt <- glmmTMB(
  n_sessions_attended ~ as.factor(modality_f)
    + as.factor(site_new)
    + ssi_bl,
  data = plf_data_treatment_sens[plf_data_treatment_sens$month == 0, ],
  family = nbinom2
)

summary(attendance_model_mitt)
```

# Were there *within-group* improvements in suicide-related coping?
```{r within group}
# Make data wide for paired t tests
plf_data_treatment_sens_wide <- plf_data_treatment_sens %>%
  filter(month %in% c(0, 3, 6, 12)) %>%
  select(id, month, srcs17, srcse, srcsi, ssi, modality_type_new) %>%
  pivot_wider(
    names_from = month,
    values_from = c(srcs17, srcse, srcsi, ssi),
    names_glue = "{.value}_month{month}"
  )

# In-person tests
paired_change_IP <- jmv::ttestPS(
  data = plf_data_treatment_sens_wide[plf_data_treatment_sens_wide$modality_type_new == 0, ],
  pairs = list(
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month3"
    ),
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month6"
    ),
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month12"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month3"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month6"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month12"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month3"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month6"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month12"
    ),
    list(
      i1 = "ssi_month0",
      i2 = "ssi_month3"
    )
  ),
  wilcoxon = TRUE,
  norm = TRUE,
  meanDiff = TRUE,
  ci = FALSE,
  effectSize = TRUE,
  ciES = FALSE,
  desc = TRUE
)

# Tele-health tests
paired_change_TH <- jmv::ttestPS(
  data = plf_data_treatment_sens_wide[plf_data_treatment_sens_wide$modality_type_new == 1, ],
  pairs = list(
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month3"
    ),
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month6"
    ),
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month12"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month3"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month6"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month12"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month3"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month6"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month12"
    ),
    list(
      i1 = "ssi_month0",
      i2 = "ssi_month3"
    )
  ),
  wilcoxon = TRUE,
  norm = TRUE,
  meanDiff = TRUE,
  ci = FALSE,
  effectSize = TRUE,
  ciES = FALSE,
  desc = TRUE
)

# Full sample tests
paired_change_full <- jmv::ttestPS(
  data = plf_data_treatment_sens_wide,
  pairs = list(
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month3"
    ),
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month6"
    ),
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month12"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month3"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month6"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month12"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month3"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month6"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month12"
    ),
    list(
      i1 = "ssi_month0",
      i2 = "ssi_month3"
    )
  ),
  wilcoxon = TRUE,
  norm = TRUE,
  meanDiff = TRUE,
  ci = FALSE,
  effectSize = TRUE,
  ciES = FALSE,
  desc = TRUE
)
# In-person
paired_change_IP

# Telehealth
paired_change_TH

# Full sample
paired_change_full
```

# Multilevel models with orthogonal polynomial contrasts for time
# Test cubic effects in both groups separately
```{r test cubic time}
src_model_cubic_ip <- lmer(
  srcs17 ~ poly(as.numeric(month), 3) +
    poly(as.numeric(month), 3) * ssi_bl +
    site_new_f +
    (1 | id),
  data = subset(plf_data_treatment_sens, modality_f == "In-person")
)

src_model_cubic_th <- lmer(
  srcs17 ~ poly(as.numeric(month), 3) +
    poly(as.numeric(month), 3) * ssi_bl +
    site_new_f +
    (1 | id),
  data = subset(plf_data_treatment_sens, modality_f == "Telehealth")
)

tab_model(
  src_model_cubic_ip,
  src_model_cubic_th
)
```

# Primary models
```{r mlms orthogonal}
# plf_data_treatment_sens$month_factor <- factor(plf_data_treatment_sens$month, ordered = TRUE)
# contrasts(plf_data_treatment_sens$month_factor) <- contr.poly(length(unique(plf_data_treatment_sens$month_factor)))

# Include linear + quadratic only (not cubic)
src_model_xcubic <- lmer(
  srcs17 ~ poly(as.numeric(month), 2) * modality_f + # Linear and quadratic
    poly(as.numeric(month), 2) * ssi_bl + # interact polynomial terms with baseline SI
    site_new_f +
    (1 | id),
  data = plf_data_treatment_sens
)

summary(src_model_xcubic)
tab_model(src_model_xcubic) # first degree (1) = linear, second degree  (2) = quadradic

srce_model_xcubic <- lmer(
  srcse ~ poly(as.numeric(month), 2) * modality_f +
    poly(as.numeric(month), 2) * ssi_bl +
    site_new_f +
    (1 | id),
  data = plf_data_treatment_sens
)

summary(srce_model_xcubic)
tab_model(srce_model_xcubic)

srci_model_xcubic <- lmer(
  srcsi ~ poly(as.numeric(month), 2) * modality_f +
    poly(as.numeric(month), 2) * ssi_bl +
    site_new_f +
    (1 | id),
  data = plf_data_treatment_sens
)

summary(srci_model_xcubic)
tab_model(srci_model_xcubic)

tab_model(
  src_model_xcubic,
  srce_model_xcubic,
  srci_model_xcubic
) # In this table,first degree (1) = linear, second degree  (2) = quadradic

lme.dscore(src_model_xcubic, data = plf_data_treatment_sens, type = "lme4")
lme.dscore(srce_model_xcubic, data = plf_data_treatment_sens, type = "lme4")
lme.dscore(srci_model_xcubic, data = plf_data_treatment_sens, type = "lme4")

# Save the models
saveRDS(src_model_xcubic, file = "03_Output/src_model_xcubic.rds")
saveRDS(srce_model_xcubic, file = "03_Output/srce_model_xcubic.rds")
saveRDS(srci_model_xcubic, file = "03_Output/srci_model_xcubic.rds")
```

Sensitivity models excluding the CTVCS site
```{r mlms orthogonal sensitivity}
# Filter the data
plf_data_treatment_sens_xtx <- plf_data_treatment_sens %>%
  filter(site_new != 4)

src_model_xcubicxtx <- lmer(
  srcs17 ~ poly(as.numeric(month), 2) * modality_f +
    poly(as.numeric(month), 2) * ssi_bl +
    site_new_f +
    (1 | id),
  data = plf_data_treatment_sens_xtx
)

summary(src_model_xcubicxtx)
tab_model(src_model_xcubicxtx)

srce_model_xcubicxtx <- lmer(
  srcse ~ poly(as.numeric(month), 2) * modality_f +
    poly(as.numeric(month), 2) * ssi_bl +
    site_new_f +
    (1 | id),
  data = plf_data_treatment_sens_xtx
)

summary(srce_model_xcubicxtx)
tab_model(srce_model_xcubicxtx)

srci_model_xcubicxtx <- lmer(
  srcsi ~ poly(as.numeric(month), 2) * modality_f +
    poly(as.numeric(month), 2) * ssi_bl +
    site_new_f +
    (1 | id),
  data = plf_data_treatment_sens_xtx
)

summary(srci_model_xcubicxtx)
tab_model(srci_model_xcubicxtx)

tab_model(
  src_model_xcubicxtx,
  srce_model_xcubicxtx,
  srci_model_xcubicxtx
)

# Save the models
saveRDS(src_model_xcubicxtx, file = "03_Output/src_model_xcubicxtx.rds")
saveRDS(srce_model_xcubicxtx, file = "03_Output/srce_model_xcubicxtx.rds")
saveRDS(srci_model_xcubicxtx, file = "03_Output/srci_model_xcubicxtx.rds")
```

# Save analysis data
```{r save data}
# Save CSV
write.csv(plf_data_treatment_sens,
  file = paste0("03_Output/analysis_data_sg_", format(Sys.Date(), "%Y-%m-%d"), ".csv"),
  row.names = FALSE
)
```

