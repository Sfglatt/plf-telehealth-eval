---
title: "03_analysis"
author: "Sglatt"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages
```{r packages}
if (!require("lme4")) {
  install.packages("lme4")
  require("lme4")
}
if (!require("lmerTest")) {
  install.packages("lmerTest")
  require("lmerTest")
}
if (!require("glmmTMB")) {
  install.packages("glmmTMB")
  require("glmmTMB")
}
if (!require("sjPlot")) {
  install.packages("sjPlot")
  require("sjPlot")
}
if (!require("jmv")) {
  install.packages("jmv")
  require("jmv")
}
if (!require("dplyr")) {
  install.packages("dplyr")
  require("dplyr")
}
if (!require("psych")) {
  install.packages("psych")
  require("psych")
}
if (!require("tidyverse")) {
  install.packages("tidyverse")
  require("tidyverse")
}
if (!require("emmeans")) {
  install.packages("emmeans")
  require("emmeans")
}
if (!require("showtext")) {
  install.packages("showtext")
  require("showtext")
}
showtext_auto()
```

```{r folder to save output}
if (!dir.exists("03_Output")) {
  dir.create("03_Output")
}
```

# Data
Data for modality x time models; created in 01_data.Rmd
```{r mlm data}
# Continuous outcomes data
plf_data_filtered <- read.csv("01_Output/treatment_data_sg_2025-12-15.csv")

# Filter outcomes data to pre and post treatment (remove -9)
plf_data_treatment <- plf_data_filtered %>%
  filter(month %in% c(0, 3, 6, 12))

# Look at modality n's
table(plf_data_treatment[plf_data_treatment$month == 0, ]$modality_type)

# Exclude multi-modal participants
plf_data_treatment_sens <- plf_data_treatment %>%
  filter(modality_type != 3)

# Make a baseline dataset
plf_data_baseline <- plf_data_treatment %>%
  filter(month == 0)

plf_data_baseline_sens <- plf_data_baseline %>%
  filter(modality_type != 3)

# Confirm
table(plf_data_baseline$modality_type_new)
```

Data for initiation/engagement; created in 01_data.Rmd
```{r itt data}
plf_data_itt <- read.csv("01_Output/initiation_data_sg_2026-01-02.csv")
```

# Make MLM vars
```{r mlms vars}
plf_data_treatment_sens <- plf_data_treatment_sens %>%
  mutate(
    modality_type_new_f = as.factor(modality_type_new), # convert original to factor
    modality_f = factor(modality_type_new_f, levels = c(0, 1), labels = c("In-person", "Telehealth")),
    month_f = factor(month, levels = c(0, 3, 6, 12)),
    site_new_f = as.factor(site_new)
  )

# Make a baseline SI variable
ssi_bl <- plf_data_treatment %>%
  filter(month == 0) %>%
  dplyr::select(id, ssi)

# Add baseline SI to all data
plf_data_treatment_sens <- plf_data_treatment_sens %>%
  left_join(ssi_bl, by = "id", suffix = c("", "_bl"))
```

# Did session attendance differ by modality?
```{r attend compare}
# in-person session attendance
summary(plf_data_baseline_sens[plf_data_baseline_sens$modality_type_new == 0, ]$n_sessions_attended)
sd(plf_data_baseline_sens[plf_data_baseline_sens$modality_type_new == 0, ]$n_sessions_attended)

# telehealth session attendance
summary(plf_data_baseline_sens[plf_data_baseline_sens$modality_type_new == 1, ]$n_sessions_attended)
sd(plf_data_baseline_sens[plf_data_baseline_sens$modality_type_new == 1, ]$n_sessions_attended)

# Comparison
wilcox.test(n_sessions_attended ~ modality_type_new, data = plf_data_baseline_sens)

# R&R, add range and IQR
plf_data_baseline_sens %>%
  group_by(modality_type_new) %>%
  summarise(
    n = n(),
    median_sessions = median(n_sessions_attended, na.rm = TRUE),
    IQR_sessions = IQR(n_sessions_attended, na.rm = TRUE)
  )
```

# Were there within-group improvements in suicide-related coping?
```{r within group}
# Make data wide for paired t tests
plf_data_treatment_sens_wide <- plf_data_treatment_sens %>%
  filter(month %in% c(0, 3)) %>%
  select(id, month, srcs17, srcse, srcsi, ssi, modality_type_new) %>%
  pivot_wider(
    names_from = month,
    values_from = c(srcs17, srcse, srcsi, ssi),
    names_glue = "{.value}_month{month}"
  )

# In-person tests
paired_change_IP <- jmv::ttestPS(
  data = plf_data_treatment_sens_wide[plf_data_treatment_sens_wide$modality_type_new == 0, ],
  pairs = list(
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month3"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month3"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month3"
    ),
    list(
      i1 = "ssi_month0",
      i2 = "ssi_month3"
    )
  ),
  wilcoxon = TRUE,
  norm = TRUE,
  meanDiff = TRUE,
  ci = FALSE,
  effectSize = TRUE,
  ciES = FALSE,
  desc = TRUE
)

# Tele-health tests
paired_change_TH <- jmv::ttestPS(
  data = plf_data_treatment_sens_wide[plf_data_treatment_sens_wide$modality_type_new == 1, ],
  pairs = list(
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month3"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month3"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month3"
    ),
    list(
      i1 = "ssi_month0",
      i2 = "ssi_month3"
    )
  ),
  wilcoxon = TRUE,
  norm = TRUE,
  meanDiff = TRUE,
  ci = FALSE,
  effectSize = TRUE,
  ciES = FALSE,
  desc = TRUE
)

# Full sample tests
paired_change_full <- jmv::ttestPS(
  data = plf_data_treatment_sens_wide,
  pairs = list(
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month3"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month3"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month3"
    ),
    list(
      i1 = "ssi_month0",
      i2 = "ssi_month3"
    )
  ),
  wilcoxon = TRUE,
  norm = TRUE,
  meanDiff = TRUE,
  ci = FALSE,
  effectSize = TRUE,
  ciES = FALSE,
  desc = TRUE
)

# In-person
paired_change_IP

# Teleheath
paired_change_TH

# Full sample
paired_change_full
```

# Multilevel models with orthogonal polynomial contrasts for time
# Test cubic effects in both groups separately
```{r test cubic time}
src_model_cubic_ip <- lmer(
  srcs17 ~ poly(as.numeric(month), 3) +
    poly(as.numeric(month), 3) * ssi_bl +
    site_new_f +
    (1 | id),
  data = subset(plf_data_treatment_sens, modality_f == "In-person")
)

src_model_cubic_th <- lmer(
  srcs17 ~ poly(as.numeric(month), 3) +
    poly(as.numeric(month), 3) * ssi_bl +
    site_new_f +
    (1 | id),
  data = subset(plf_data_treatment_sens, modality_f == "Telehealth")
)

tab_model(
  src_model_cubic_ip,
  src_model_cubic_th
)
```

# Primary models
```{r mlms orthogonal}
# plf_data_treatment_sens$month_factor <- factor(plf_data_treatment_sens$month, ordered = TRUE)
# contrasts(plf_data_treatment_sens$month_factor) <- contr.poly(length(unique(plf_data_treatment_sens$month_factor)))

# Include linear + quadratic only (not cubic)
src_model_xcubic <- lmer(
  srcs17 ~ poly(as.numeric(month), 2) * modality_f + # Linear and quadratic
    poly(as.numeric(month), 2) * ssi_bl + # interact polynomial terms with baseline SI
    site_new_f +
    (1 | id),
  data = plf_data_treatment_sens
)

summary(src_model_xcubic)
tab_model(src_model_xcubic) # first degree (1) = linear, second degree  (2) = quadradic

srce_model_xcubic <- lmer(
  srcse ~ poly(as.numeric(month), 2) * modality_f +
    poly(as.numeric(month), 2) * ssi_bl +
    site_new_f +
    (1 | id),
  data = plf_data_treatment_sens
)

summary(srce_model_xcubic)
tab_model(srce_model_xcubic)

srci_model_xcubic <- lmer(
  srcsi ~ poly(as.numeric(month), 2) * modality_f +
    poly(as.numeric(month), 2) * ssi_bl +
    site_new_f +
    (1 | id),
  data = plf_data_treatment_sens
)

summary(srci_model_xcubic)
tab_model(srci_model_xcubic)

tab_model(
  src_model_xcubic,
  srce_model_xcubic,
  srci_model_xcubic
)
# In this table,first degree (1) = linear, second degree  (2) = quadradic
```

Sensitivity models excluding the CTVCS site
```{r mlms orthogonal sensitivity}
# Filter the data
plf_data_treatment_sens_xtx <- plf_data_treatment_sens %>%
  filter(site_new != 4)

src_model_xcubicxtx <- lmer(
  srcs17 ~ poly(as.numeric(month), 2) * modality_f +
    poly(as.numeric(month), 2) * ssi_bl +
    site_new_f +
    (1 | id),
  data = plf_data_treatment_sens_xtx
)

summary(src_model_xcubicxtx)
tab_model(src_model_xcubicxtx)

srce_model_xcubicxtx <- lmer(
  srcse ~ poly(as.numeric(month), 2) * modality_f +
    poly(as.numeric(month), 2) * ssi_bl +
    site_new_f +
    (1 | id),
  data = plf_data_treatment_sens_xtx
)

summary(srce_model_xcubicxtx)
tab_model(srce_model_xcubicxtx)

srci_model_xcubicxtx <- lmer(
  srcsi ~ poly(as.numeric(month), 2) * modality_f +
    poly(as.numeric(month), 2) * ssi_bl +
    site_new_f +
    (1 | id),
  data = plf_data_treatment_sens_xtx
)

summary(srci_model_xcubicxtx)
tab_model(srci_model_xcubicxtx)

tab_model(
  src_model_xcubicxtx,
  srce_model_xcubicxtx,
  srci_model_xcubicxtx
)
```

# Model visualizations
Estimated marginal means
```{r emm vis}
time_points <- c(0, 3, 6, 12)

# quick function
get_preds <- function(model, outcome_name) {
  emms <- emmeans(model, ~ modality_f | month, at = list(month = time_points))
  df <- as.data.frame(emms)
  df$outcome <- outcome_name
  df
}

# Get predictions for each outcome
pred_srcs17 <- get_preds(src_model_xcubic, "Total")
pred_srce <- get_preds(srce_model_xcubic, "External")
pred_srci <- get_preds(srci_model_xcubic, "Internal")
pred_all <- bind_rows(pred_srcs17, pred_srce, pred_srci) # Combine
pred_all$outcome <- factor(pred_all$outcome, levels = c("Total", "External", "Internal"))

# Plot
mlm_vis_full <- ggplot(pred_all, aes(x = month, y = emmean, color = modality_f, group = modality_f)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = lower.CL, ymax = upper.CL, fill = modality_f), alpha = 0.2, color = NA) +
  facet_wrap(~outcome, scales = "free_y", nrow = 1) +
  labs(x = "Month", y = "Estimated Score", color = "Modality", fill = "Modality") +
  theme_minimal(base_size = 14, base_family = "serif") +
  theme(
    legend.position = "bottom",
    strip.text = element_text(face = "bold", family = "serif")
  )
```

```{r emm vis sensitivity}
# Get predictions for each outcome
xtx_pred_srcs17 <- get_preds(src_model_xcubicxtx, "Total")
xtx_pred_srce <- get_preds(srce_model_xcubicxtx, "External")
xtx_pred_srci <- get_preds(srci_model_xcubicxtx, "Internal")
xtx_pred_all <- bind_rows(xtx_pred_srcs17, xtx_pred_srce, xtx_pred_srci) # Combine
xtx_pred_all$outcome <- factor(xtx_pred_all$outcome, levels = c("Total", "External", "Internal"))

# Plot
mlm_vis_sens <- ggplot(xtx_pred_all, aes(x = month, y = emmean, color = modality_f, group = modality_f)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = lower.CL, ymax = upper.CL, fill = modality_f), alpha = 0.2, color = NA) +
  facet_wrap(~outcome, scales = "free_y", nrow = 1) +
  labs(x = "Month", y = "Estimated Score", color = "Modality", fill = "Modality") +
  theme_minimal(base_size = 14, base_family = "serif") +
  theme(
    legend.position = "bottom",
    strip.text = element_text(face = "bold", family = "serif")
  )

mlm_vis_full / mlm_vis_sens
```

# Raw data vis
```{r visualize raw}
# Reformat data
sr_raw <- plf_data_treatment_sens %>%
  dplyr::select(id, month, modality_f, srcs17, srcse, srcsi) %>%
  pivot_longer(
    cols = c(srcs17, srcse, srcsi),
    names_to = "outcome",
    values_to = "score"
  ) %>%
  mutate(
    month = factor(month, levels = c(0, 3, 6, 12)),
    outcome = factor(outcome,
      levels = c("srcs17", "srcse", "srcsi"),
      labels = c("Total", "External", "Internal")
    )
  )

# Plot
ggplot(sr_raw, aes(x = month, y = score, color = modality_f, group = modality_f)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun.data = mean_se, geom = "ribbon", alpha = 0.2, aes(fill = modality_f), color = NA) +
  facet_wrap(~outcome, scales = "free_y", nrow = 1) +
  labs(x = "Month", y = "Observed Score", color = "Modality", fill = "Modality") +
  theme_minimal(base_size = 14, base_family = "serif") +
  theme(
    legend.position = "bottom",
    strip.text = element_text(face = "bold", family = "serif")
  )
```

# Treatment engagement and completion  
- In the full intent-to-treat sample so to not condition on treatment initiation 
- Based on randomization assignment to in-person versus telehealth delivery; 
  participants who transitioned modalities due to COVID-19 were classified according to their original assignment for ITT purposes
```{r tx engage}
# Model treatment engagement and completion as ITT outcomes,
# not a group descriptor

# Initiation model (>0 sessions)
initiation_model <- glm(
  initiated ~ as.factor(modality_assign) + as.factor(site_new) + ssi,
  data = plf_data_itt,
  family = binomial
)

summary(initiation_model)
exp(cbind(
  OR = coef(initiation_model),
  confint(initiation_model)
))

# Engagement model (> 5 sessions)
engagement_model <- glm(
  six_sess ~ as.factor(modality_assign) + as.factor(site_new) + ssi,
  data = plf_data_itt,
  family = binomial
)

summary(engagement_model)
exp(cbind(
  OR = coef(engagement_model),
  confint(engagement_model)
))

# Completion model (10+ sessions)
completion_model <- glm(
  completer ~ as.factor(modality_assign) + as.factor(site_new) + ssi,
  data = plf_data_itt,
  family = binomial
)

summary(completion_model)
exp(cbind(
  OR = coef(completion_model),
  confint(completion_model)
))

# Session count model
# Check for overdisperson
mean(plf_data_itt$n_sessions_attended, na.rm = TRUE)
var(plf_data_itt$n_sessions_attended, na.rm = TRUE)
# Variance is > mean, so use a negative binomial model
attendance_model <- glmmTMB(
  n_sessions_attended ~ as.factor(modality_assign) + ssi + as.factor(site_new),
  data = plf_data_itt,
  family = nbinom2
)

summary(attendance_model)
```
