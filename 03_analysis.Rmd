---
title: "03_analysis"
author: "Sglatt"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages
```{r packages}
if (!require("report")) {
  install.packages("report")
  require("report")
}
if (!require("lme4")) {
  install.packages("lme4")
  require("lme4")
}
if (!require("lmerTest")) {
  install.packages("lmerTest")
  require("lmerTest")
}
if (!require("sjPlot")) {
  install.packages("sjPlot")
  require("sjPlot")
}
if (!require("jmv")) {
  install.packages("jmv")
  require("jmv")
}
if (!require("dplyr")) {
  install.packages("dplyr")
  require("dplyr")
}
if (!require("psych")) {
  install.packages("psych")
  require("psych")
}
if (!require("tidyverse")) {
  install.packages("tidyverse")
  require("tidyverse")
}
```

```{r folder to save output}
if (!dir.exists("03_Output")) {
  dir.create("03_Output")
}
```

# Data
Created in 01_data.Rmd
```{r data}
# Continuous outcomes data
plf_data_filtered <- read.csv("01_Output/treatment_data_sg_2025-10-21.csv")

# Filter outcomes data to pre and post treatment
plf_data_treatment <- plf_data_filtered %>%
  filter(month %in% c(0, 3, 6, 12))

# Prep variables
plf_data_treatment$site_new_f <- as.factor(plf_data_treatment$site_new)
plf_data_treatment$modality_type_new_f <- as.factor(plf_data_treatment$modality_type_new)
plf_data_treatment$month <- as.factor(plf_data_treatment$month)

# Exclude multi-modal participants
plf_data_treatment_sens <- plf_data_treatment %>%
  filter(modality_type != 3)

# + make a baseline dataset
plf_data_baseline <- plf_data_treatment %>%
  filter(month == 0)

plf_data_baseline_sens <- plf_data_baseline %>%
  filter(modality_type != 3)

# Confirm
table(plf_data_baseline$modality_type_new_f)
```

# Did session attendance differ by modality?
```{r attend compare}
# in-person session attendance
summary(plf_data_baseline_sens[plf_data_baseline_sens$modality_type_new == 0, ]$n_sessions_attended)
sd(plf_data_baseline_sens[plf_data_baseline_sens$modality_type_new == 0, ]$n_sessions_attended)

# telehealth session attendance
summary(plf_data_baseline_sens[plf_data_baseline_sens$modality_type_new == 1, ]$n_sessions_attended)
sd(plf_data_baseline_sens[plf_data_baseline_sens$modality_type_new == 1, ]$n_sessions_attended)

# comparison
wilcox.test(n_sessions_attended ~ modality_type_new, data = plf_data_baseline_sens)
```

# Did number of treatment engagers differ by modality?
```{r engage rates}
table(
  plf_data_baseline_sens$six_sess,
  plf_data_baseline_sens$modality_type_new
)

chi_square_result_1 <- chisq.test(
  plf_data_baseline_sens$six_sess,
  plf_data_baseline_sens$modality_type_new
)

fisher_result_1 <- fisher.test(
  plf_data_baseline_sens$six_sess,
  plf_data_baseline_sens$modality_type_new
)

report(chi_square_result_1)
fisher_result_1
```

# Did number of treatment completers differ by modality?
```{r complete rates}
table(
  plf_data_baseline_sens$completer,
  plf_data_baseline_sens$modality_type_new
)

chi_square_result_2 <- chisq.test(plf_data_baseline_sens$completer, plf_data_baseline_sens$modality_type_new)
fisher_result_2 <- fisher.test(plf_data_baseline_sens$completer, plf_data_baseline_sens$modality_type_new)

report(chi_square_result_2)
fisher_result_2
```

# Sensitivity including mixed-modality participants
```{r sens rates}
# Engagers by modality
table(plf_data_baseline$six_sess, plf_data_baseline$modality_type_new)

chi_square_result_3 <- chisq.test(plf_data_baseline$six_sess, plf_data_baseline$modality_type_new)
fisher_result_3 <- fisher.test(plf_data_baseline$six_sess, plf_data_baseline$modality_type_new)

report(chi_square_result_3)
fisher_result_3

# Completers by modality
table(plf_data_baseline$completer, plf_data_baseline$modality_type_new)

chi_square_result_4 <- chisq.test(plf_data_baseline$completer, plf_data_baseline$modality_type_new)
fisher_result_4 <- fisher.test(plf_data_baseline$completer, plf_data_baseline$modality_type_new)

report(chi_square_result_4)
fisher_result_4
```

# Was there within-group improvements in suicide-related coping?
```{r within group}
# Make data wide for paired t tests
plf_data_treatment_sens_wide <- plf_data_treatment_sens %>%
  filter(month %in% c(0, 3)) %>%
  select(id, month, srcs17, srcse, srcsi, ssi, modality_type_new) %>%
  pivot_wider(
    names_from = month,
    values_from = c(srcs17, srcse, srcsi, ssi),
    names_glue = "{.value}_month{month}"
  )

# In-person tests
paired_change_IP <- jmv::ttestPS(
  data = plf_data_treatment_sens_wide[plf_data_treatment_sens_wide$modality_type_new == 0, ],
  pairs = list(
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month3"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month3"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month3"
    ),
    list(
      i1 = "ssi_month0",
      i2 = "ssi_month3"
    )
  ),
  wilcoxon = TRUE,
  norm = TRUE,
  meanDiff = TRUE,
  ci = FALSE,
  effectSize = TRUE,
  ciES = FALSE,
  desc = TRUE
)

# Tele-health tests
paired_change_TH <- jmv::ttestPS(
  data = plf_data_treatment_sens_wide[plf_data_treatment_sens_wide$modality_type_new == 1, ],
  pairs = list(
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month3"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month3"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month3"
    ),
    list(
      i1 = "ssi_month0",
      i2 = "ssi_month3"
    )
  ),
  wilcoxon = TRUE,
  norm = TRUE,
  meanDiff = TRUE,
  ci = FALSE,
  effectSize = TRUE,
  ciES = FALSE,
  desc = TRUE
)

# Full sample tests
paired_change_full <- jmv::ttestPS(
  data = plf_data_treatment_sens_wide,
  pairs = list(
    list(
      i1 = "srcs17_month0",
      i2 = "srcs17_month3"
    ),
    list(
      i1 = "srcse_month0",
      i2 = "srcse_month3"
    ),
    list(
      i1 = "srcsi_month0",
      i2 = "srcsi_month3"
    ),
    list(
      i1 = "ssi_month0",
      i2 = "ssi_month3"
    )
  ),
  wilcoxon = TRUE,
  norm = TRUE,
  meanDiff = TRUE,
  ci = FALSE,
  effectSize = TRUE,
  ciES = FALSE,
  desc = TRUE
)

# In-person
paired_change_IP

# Teleheath
paired_change_TH

# Full sample
paired_change_full
```

# Mixed models
With SSI as a covariate (see 02_descriptives.Rmd)
```{r mlms}
src_model_1 <- lmer(srcs17 ~
  month:modality_type_new_f +
  month +
  modality_type_new_f +
  site_new_f +
  ssi +
  (1 | id), data = plf_data_treatment_sens)

srce_model_1 <- lmer(srcse ~
  month:modality_type_new_f +
  month +
  modality_type_new_f +
  site_new_f +
  ssi +
  (1 | id), data = plf_data_treatment_sens)

srci_model_1 <- lmer(srcsi ~
  month:modality_type_new_f +
  month +
  modality_type_new_f +
  site_new_f +
  ssi +
  (1 | id), data = plf_data_treatment_sens)

# Results
summary(src_model_1)
summary(srce_model_1)
summary(srci_model_1)

# Results table
tab_model(
  src_model_1,
  srce_model_1,
  srci_model_1
)
```

# Recode so that TH = 0
```{r mlms reverse}
plf_data_treatment_sens$modality_rev <- ifelse(plf_data_treatment_sens$modality_type_new_f == 0, 1, 0)
table(plf_data_treatment_sens$modality_rev)
table(plf_data_treatment_sens$modality_type_new_f)


src_model_1 <- lmer(srcs17 ~
  month:modality_rev +
  month +
  modality_rev +
  site_new_f +
  ssi +
  (1 | id), data = plf_data_treatment_sens)

srce_model_1 <- lmer(srcse ~
  month:modality_rev +
  month +
  modality_rev +
  site_new_f +
  ssi +
  (1 | id), data = plf_data_treatment_sens)

srci_model_1 <- lmer(srcsi ~
  month:modality_rev +
  month +
  modality_rev +
  site_new_f +
  ssi +
  (1 | id), data = plf_data_treatment_sens)

# Results
summary(src_model_1)
summary(srce_model_1)
summary(srci_model_1)

# Results table
tab_model(
  src_model_1,
  srce_model_1,
  srci_model_1
)
```

