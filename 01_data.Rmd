---
title: "01_data"
author: "Sglatt"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Github
```{r git, eval=FALSE}
usethis::create_from_github("https://github.com/Sfglatt/plf-telehealth-eval.git",
  destdir = "~/Github/plf-telehealth-eval"
)
```

```{r packages}
if (!require("dplyr")) {
  install.packages("dplyr")
  require("dplyr")
}
if (!require("psych")) {
  install.packages("psych")
  require("psych")
}
if (!require("readxl")) {
  install.packages("readxl")
  require("readxl")
}
if (!require("stringr")) {
  install.packages("stringr")
  require("stringr")
}
if (!require("tidyverse")) {
  install.packages("tidyverse")
  require("tidyverse")
}
```

```{r folder to save output}
if (!dir.exists("01_Output")) {
  dir.create("01_Output")
}
```

```{r Data}
# Raw data in separate tabs
path <- "~/Labs/Github/project-life-force/project-life-force/Raw_datasets/database_12-29-2024.xlsx"
excel_sheets(path)

# This tab has lifetime SA information. Month = -9 is lifetime.
csrss <- read_excel(path, sheet = "cssrs")

# Make a variable for C-SSRS month = -9
csrss <- csrss %>%
  group_by(id) %>%
  mutate(q11_CSSRS_lifetime = q11[month == -9]) %>%
  ungroup()

# Recode No (2) as 0
csrss <- csrss %>%
  mutate(q11_CSSRS_lifetime = ifelse(q11_CSSRS_lifetime == 2, 0, q11_CSSRS_lifetime))

# This tab has sessions data
sessions <- read_excel(path, sheet = "sessions")
colnames(sessions) <- gsub("\\s+", "_", colnames(sessions))

# Verify the number of participants
length(unique(sessions$id)) # N = 101

# Make a 'total number of sessions attended' variable.
# Add up the number of dates they attended.
sessions <- sessions %>%
  group_by(id) %>%
  mutate(n_attended = if_else(arm == 1, sum(!is.na(date)), NA))

# Make a "treatment engaged" and "treatment completed" variables based on the number of sessions they attended
sessions$initiated <- ifelse(sessions$n_attended > 0, 1, 0)
sessions$six_sess <- ifelse(sessions$n_attended > 5, 1, 0)
sessions$completer <- ifelse(sessions$n_attended >= 10, 1, 0)

# Look at modality
table(unique(sessions[c("id", "type")])$type)

# 1	In-person (n = 22)
# 2	Telehealth (n = 44)
# 3	Both (n = 4)
# People who attended 0 sessions are not coded

# Make another modality type variable with "both" included in "telehealth"
sessions$type_new <- sessions$type
sessions$type_new[sessions$type_new == 3] <- 2
sessions$type_new[sessions$type_new == 1] <- 0
sessions$type_new[sessions$type_new == 2] <- 1

# Replace NA (i.e., missing type) with 0 for non-attenders (for both the original site and site_new)
sessions$type_NA <- sessions$type
sessions$type_NA[is.na(sessions$type)] <- 0

sessions$type_new_NA <- sessions$type_new
sessions$type_new_NA[is.na(sessions$type_new)] <- 0

# Confirm the changes
table(unique(sessions[c("id", "type_new")])$type_new)
table(unique(sessions[c("id", "type_new_NA")])$type_new_NA)
```

```{r self-report}
# Combined self-report data
plf_data <- read.csv("~/Labs/Github/project-life-force/project-life-force/01_Created_datasets/Merged_plf_data_filtered_2025-04-09.csv")

# Look at site n's
table(plf_data[plf_data$month == 0, ]$site)

# Combine Northport (n = 2) and Bronx participants
plf_data <- plf_data %>%
  group_by(id) %>%
  tidyr::fill(site, .direction = "downup") %>%
  ungroup()

plf_data <- plf_data %>%
  mutate(
    site_new = site,
    site_new = ifelse(site_new == 2, 1, site_new)
  )

# Confirm
table(plf_data[plf_data$month == 0, ]$site)
table(plf_data[plf_data$month == 0, ]$site_new)

# Make a labeled arm variable
plf_data <- plf_data %>%
  dplyr::mutate(arm_label = ifelse(arm_rec == 1, "PLF", "TAU"))

# Add n_sessions_attended and modality_type_new
plf_data$n_sessions_attended <- sessions$n_attended[match(plf_data$id, sessions$id)]
plf_data$modality_type <- sessions$type[match(plf_data$id, sessions$id)]
plf_data$modality_type_new <- sessions$type_new[match(plf_data$id, sessions$id)]
plf_data$completer <- sessions$completer[match(plf_data$id, sessions$id)]
plf_data$six_sess <- sessions$six_sess[match(plf_data$id, sessions$id)]
plf_data$initiated <- sessions$initiated[match(plf_data$id, sessions$id)]

# Add the lifetime C-SSRS
plf_data$q11_CSSRS_lifetime <- csrss$q11_CSSRS_lifetime[match(plf_data$id, csrss$id)]

# Filter the dataset to PLF and >0 sessions
plf_data_filtered <- plf_data %>%
  filter(
    arm_label == "PLF",
    n_sessions_attended > 0,
    month != -9
  )
```

# How many total were randomzed to telehealth/in-person/both
```{r numbers}
# How many don't have a modality logged
unique(sessions$id[is.na(sessions$type) | sessions$type == ""]) # 31

# Look at their data
sessions[is.na(sessions$type) | sessions$type == "", ]

# Look at their date of consent
dates <- read_excel(path, sheet = "status")
# dtcon, dtcm00

# Look at the data for people who are missing modality type
missing_modality_ids <- unique(sessions$id[is.na(sessions$type) | sessions$type == ""])
dates[dates$id %in% missing_modality_ids, ]

# The breakdown in the sessions data
table(plf_data[plf_data$arm_rec == 1 & plf_data$month == 0, ]$modality_type)

# The breakdown in the dates data
table(dates[dates$arm == 1, ]$tele)

# From this dates data, include people who initiated treatment
dates_initiated <- dates %>%
  filter(id %in% sessions$id[sessions$initiated == 1])
view(dates_initiated)

# The breakdown in the dates data
table(dates_initiated$arm, dates_initiated$tele)

# Check that they concord
common_ids <- intersect(dates$id, sessions$id)
dates_sub <- dates[dates$id %in% common_ids, c("id", "tele")]
sessions_sub <- sessions[sessions$id %in% common_ids, c("id", "type")]
comparison <- merge(dates_sub, sessions_sub, by = "id")
all_match <- all(comparison$tele == comparison$type)
mismatched_ids <- comparison$id[comparison$tele != comparison$type]

# There is one person characterized as mixed in the "status" tab and "in-person" in the sessions tab. Check who:
intersect(
  dates$id[dates$tele == "3"],
  sessions$id[sessions$type == "1"]
)

# 083. Look at their data in the sessions vs dates tab
sessions[sessions$id == "BX-083", ]
dates[dates$id == "BX-083", ]
# MG resolution: this person is in-person

# From this dates data, exclude people who initiated treatment
dates_exclude <- dates %>%
  filter(id %in% sessions$id[sessions$n_attended == 0])

# The breakdown in the dates data
table(dates_exclude$arm, dates_exclude$tele)

# Who is mixed in the tele variable here?
dates_exclude$id[dates_exclude$tele == "3"] # BX-085
# Look at their data
sessions[sessions$id == "BX-085", ]
dates[dates$id == "BX-085", ]
# They were randomized to in-person (Jan 2020), but never attended any sessions.

# Make their tele 3 to 1 in the full dates data, and do the same for "083" above
dates$tele[dates$id == "BX-085"] <- "1"
dates$tele[dates$id == "BX-083"] <- "1"
```

# Save data for MLMs
```{r save mlm data, eval=FALSE}
write.csv(
  plf_data_filtered,
  paste0("01_Output/treatment_data_sg_", Sys.Date(), ".csv")
)
# 2025-10-21: First filtered multi-wave data
# 2025-12-15: Add C-SSRS
```

# Save data for ITT engagement/initiation
```{r save itt data, eval=FALSE}
# From the dates sheet, make a modality assignment variable
dates <- dates %>%
  mutate(
    modality_assign = case_when(
      tele == "1" ~ 0, # in-person
      tele == "2" ~ 1, # telehealth
      tele == "3" ~ 0, # in person and shifted to telehealth - in person for ITT
    )
  )

table(dates$modality_assign, useNA = "ifany")

# Merge modality assignment (ITT) into the dataset
plf_data <- plf_data %>%
  left_join(
    dates %>% dplyr::select(id, modality_assign),
    by = "id"
  )

# Filter to baseline and the PLF arm
plf_data_m0_plf <- plf_data %>%
  dplyr::filter(month == 0, arm_rec == 1)

# Look/confirm N's
table(plf_data_m0_plf$modality_assign, useNA = "ifany") # 0 = telehealth, 46; 1 = in-person, 55

# Save data
write.csv(
  plf_data_m0_plf,
  paste0("01_Output/initiation_data_sg_", Sys.Date(), ".csv")
)
# 2026-01-02: First filtered ITT data for initation/engagement
```

